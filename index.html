<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo com Filtros</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/selectize/dist/css/selectize.bootstrap3.css" rel="stylesheet">
    <style>
        #map { height: 100vh; width: 100vw; }
        .filters {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            z-index: 1000;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            font-size: 12px;
            border-radius: 10px;
        }
        .legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="filters">
        <select id="cddFilter" placeholder="Escolha o CDD" multiple></select>
        <select id="dayFilter" placeholder="Tipo de Camada" multiple></select>
        <select id="inplantFilter" placeholder="Filtrar por Inplant" multiple></select>
        <select id="gnFilter" placeholder="Filtrar por GN" multiple></select>
        <select id="redeFilter" placeholder="Filtrar por Rede" multiple></select>
    </div>
    <div id="map"></div>
    <div class="legend">
        <strong>Legenda:</strong><br>
        <span style="background:red;"></span> Segunda<br>
        <span style="background:orange;"></span> Terça<br>
        <span style="background:yellow;"></span> Quarta<br>
        <span style="background:green;"></span> Quinta<br>
        <span style="background:blue;"></span> Sexta<br>
        <span style="background:purple;"></span> Sábado<br>
        <span style="background:gray;"></span> Agenda
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/selectize"></script>
    <script>
        const map = L.map('map').setView([-15.78, -47.93], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const layerGroup = L.layerGroup().addTo(map);

        const colorMap = {
            'Segunda': 'red',
            'Terça': 'orange',
            'Quarta': 'yellow',
            'Quinta': 'green',
            'Sexta': 'blue',
            'Sábado': 'purple',
            'Agenda': 'gray'
        };

        const filters = {
            cdd: [],
            day: [],
            inplant: [],
            gn: [],
            rede: []
        };

        function updateMap(data) {
            layerGroup.clearLayers();
            data.forEach(row => {
                if (
                    (filters.cdd.length === 0 || filters.cdd.includes(row.CDD)) &&
                    (filters.day.length === 0 || filters.day.includes(row.Dia)) &&
                    (filters.inplant.length === 0 || filters.inplant.includes(row.Inplant)) &&
                    (filters.gn.length === 0 || filters.gn.includes(row.GN)) &&
                    (filters.rede.length === 0 || filters.rede.includes(row.Rede))
                ) {
                    const marker = L.circleMarker([+row.Latitude, +row.Longitude], {
                        color: colorMap[row.Dia] || 'black',
                        radius: 6
                    }).bindPopup(`<strong>${row.Loja}</strong><br>${row.Rede}<br>${row.CDD}<br>${row.Inplant}<br>${row.GN}<br>${row.Dia}`);
                    layerGroup.addLayer(marker);
                }
            });
        }

        function populateFilters(data) {
            const cdds = [...new Set(data.map(r => r.CDD))];
            const days = [...new Set(data.map(r => r.Dia))];
            const inplants = [...new Set(data.map(r => r.Inplant))];
            const gns = [...new Set(data.map(r => r.GN))];
            const redes = [...new Set(data.map(r => r.Rede))];

            function initSelect(id, values, key) {
                const select = $(id);
                values.forEach(val => select.append(new Option(val, val)));
                select.selectize({
                    plugins: ['remove_button'],
                    onChange: val => {
                        filters[key] = val;
                        updateMap(window.csvData);
                    }
                });
            }

            initSelect('#cddFilter', cdds, 'cdd');
            initSelect('#dayFilter', days, 'day');
            initSelect('#inplantFilter', inplants, 'inplant');
            initSelect('#gnFilter', gns, 'gn');
            initSelect('#redeFilter', redes, 'rede');
        }

        Papa.parse('https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv', {
            download: true,
            header: true,
            complete: results => {
                window.csvData = results.data;
                populateFilters(results.data);
                updateMap(results.data);
            }
        });
    </script>
</body>
</html>