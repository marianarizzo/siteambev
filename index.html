<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo - Ambev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 0;
    }
    .filtros {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      max-width: calc(100vw - 40px);
      padding: 10px;
    }
    .filtros label {
      font-size: 12px;
      margin-bottom: 4px;
      display: block;
      font-weight: bold;
    }
    .filtros .select-wrapper {
      display: flex;
      flex-direction: column;
    }
    .filtros select {
      font-size: 13px;
      width: 200px;
      min-height: 48px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 6px 10px;
      background-color: #f7f7f7;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #botaoHeatmap {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: white;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-family: Arial, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      z-index: 1001;
    }
    #legenda {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="filtros">
    <div class="select-wrapper"><label for="filtroCDD">CDD</label><select id="filtroCDD" multiple></select></div>
    <div class="select-wrapper"><label for="filtroGN">GN</label><select id="filtroGN" multiple></select></div>
    <div class="select-wrapper"><label for="filtroInplant">Inplant</label><select id="filtroInplant" multiple></select></div>
    <div class="select-wrapper"><label for="filtroRede">Rede</label><select id="filtroRede" multiple></select></div>
    <div class="select-wrapper"><label for="filtroDia">Dia</label><select id="filtroDia" multiple></select></div>
  </div>

  <button id="botaoHeatmap">Ativar Heatmap</button>
  <div id="map"></div>

  <div id="legenda">
    <b>Legenda:</b>
    <span style="color:red;">‚óè Agenda</span> |
    <span style="color:blue;">‚óè Segunda</span> |
    <span style="color:green;">‚óè Ter√ßa</span> |
    <span style="color:purple;">‚óè Quarta</span> |
    <span style="color:brown;">‚óè Quinta</span> |
    <span style="color:black;">‚óè Sexta</span> |
    <span style="color:orange;">‚óè S√°bado</span> |
    <span style="color:darkorange;">üî• Heatmap</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
    const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';
    const map = L.map('map').setView([-15.7797, -47.9297], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const grupoMarcadores = L.layerGroup().addTo(map);
    let heatLayer;

    const iconCDD = L.icon({
      iconUrl: 'https://www.flaticon.com/free-icon/location-pin_2776067?term=location&page=1&position=24&origin=search&related_id=2776067',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -30]
    });

    const cddLocations = [
      { name: 'GAM', lat: -16.001772915238647, lon: -48.05215353019492 },
      { name: 'CUI', lat: -15.56189216397978, lon: -56.12758838443211 },
      { name: 'GOI', lat: -16.609740763065844, lon: -49.292487087578984 },
      { name: 'MAN', lat: -3.021734706895321, lon: -60.02195693918584 }
    ];

    const filtros = {
      CDD: new Choices('#filtroCDD', { removeItemButton: true }),
      GN: new Choices('#filtroGN', { removeItemButton: true }),
      Inplant: new Choices('#filtroInplant', { removeItemButton: true }),
      Rede: new Choices('#filtroRede', { removeItemButton: true }),
      Dia: new Choices('#filtroDia', { removeItemButton: true })
    };

    const coresPorDia = {
      'Agenda': 'red',
      'Segunda': 'blue',
      'Ter√ßa': 'green',
      'Quarta': 'purple',
      'Quinta': 'brown',
      'Sexta': 'black',
      'S√°bado': 'orange'
    };

    function preencherFiltros(dados, chave, controle) {
      const valores = [...new Set(dados.map(d => d[chave]).filter(Boolean))].sort();
      controle.clearChoices();
      controle.setChoices(valores.map(v => ({ value: v, label: v })), 'value', 'label', true);
    }

    function atualizarMapa(dados) {
      grupoMarcadores.clearLayers();
      cddLocations.forEach(location => {
        const marker = L.marker([location.lat, location.lon], { icon: iconCDD }).bindPopup(
          `<b>${location.name}</b><br>Latitude: ${location.lat}<br>Longitude: ${location.lon}`
        );
        grupoMarcadores.addLayer(marker);
      });

      if (heatLayer) map.removeLayer(heatLayer);
      let heatData = [];

      const cdd = filtros.CDD.getValue(true);
      const gn = filtros.GN.getValue(true);
      const inplant = filtros.Inplant.getValue(true);
      const rede = filtros.Rede.getValue(true);
      const diasSelecionados = filtros.Dia.getValue(true);

      dados.forEach(d => {
        const lat = parseFloat(d['LAT']);
        const lon = parseFloat(d['LONG']);
        if (isNaN(lat) || isNaN(lon)) return;

        const cddValido = cdd.length === 0 || cdd.includes(d['CDD']);
        const gnValido = gn.length === 0 || gn.includes(d['GN']);
        const inplantValido = inplant.length === 0 || inplant.includes(d['Inplant']);
        const redeValido = rede.length === 0 || rede.includes(d['Rede']);
        let diaValido = false;
        let cor = 'gray';

        if (diasSelecionados.length === 0) {
          const dias = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
          for (let dia of dias) {
            if (d[dia]?.trim() === '1') {
              cor = coresPorDia[dia];
              diaValido = true;
              break;
            }
          }
          const isAgenda = dias.every(dia => d[dia]?.trim() === '1');
          if (isAgenda) {
            diaValido = true;
            cor = coresPorDia['Agenda'];
          }
        } else {
          if (diasSelecionados.includes('Agenda')) {
            const isAgenda = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'].every(dia => d[dia]?.trim() === '1');
            if (isAgenda) {
              diaValido = true;
              cor = coresPorDia['Agenda'];
            }
          }
          if (!diaValido) {
            for (let dia of diasSelecionados) {
              if (d[dia]?.trim() === '1') {
                cor = coresPorDia[dia];
                diaValido = true;
                break;
              }
            }
          }
        }

        if (cddValido && gnValido && inplantValido && redeValido && diaValido) {
          heatData.push([lat, lon, 1]);
          const marker = L.circleMarker([lat, lon], {
            radius: 6,
            color: cor,
            fillColor: cor,
            fillOpacity: 0.8,
            weight: 1
          }).bindPopup(
            `<b>${d['Nome']}</b><br>CDD: ${d['CDD']}<br>GN: ${d['GN']}<br>Inplant: ${d['Inplant']}<br>Rede: ${d['Rede']}`
          );
          grupoMarcadores.addLayer(marker);
        }
      });

      heatLayer = L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 10 });
    }

    Papa.parse(url, {
      download: true,
      header: true,
      complete: results => {
        const dados = results.data;
        preencherFiltros(dados, 'CDD', filtros.CDD);
        preencherFiltros(dados, 'GN', filtros.GN);
        preencherFiltros(dados, 'Inplant', filtros.Inplant);
        preencherFiltros(dados, 'Rede', filtros.Rede);

        filtros.Dia.clearChoices();
        filtros.Dia.setChoices([
          { value: 'Agenda', label: 'Agenda' },
          { value: 'Segunda', label: 'Segunda' },
          { value: 'Ter√ßa', label: 'Ter√ßa' },
          { value: 'Quarta', label: 'Quarta' },
          { value: 'Quinta', label: 'Quinta' },
          { value: 'Sexta', label: 'Sexta' },
          { value: 'S√°bado', label: 'S√°bado' }
        ], 'value', 'label', true);

        atualizarMapa(dados);

        Object.values(filtros).forEach(f => {
          f.passedElement.element.addEventListener('change', () => atualizarMapa(dados));
        });

        document.getElementById('botaoHeatmap').addEventListener('click', () => {
          if (map.hasLayer(heatLayer)) {
            map.removeLayer(heatLayer);
          } else {
            heatLayer.addTo(map);
          }
        });
      }
    });
  </script>
</body>
</html>