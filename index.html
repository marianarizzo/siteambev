<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo - Ambev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }

    .filtros {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 10px;
    }

    .choices__inner {
      min-height: 32px;
      font-size: 12px;
    }

    .heat-toggle {
      margin-top: 6px;
      padding: 6px;
      font-size: 13px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
    }

    #legenda {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 6px 14px;
      font-size: 13px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
  </style>
</head>
<body>
<div class="filtros">
  <select id="filtroCDD" multiple></select>
  <select id="filtroGN" multiple></select>
  <select id="filtroInplant" multiple></select>
  <select id="filtroRede" multiple></select>
  <select id="filtroDia" multiple></select>
  <div class="heat-toggle" id="heatToggle">Alternar Heatmap</div>
</div>
<div id="map"></div>
<div id="legenda">
  <b>Legenda:</b>
  <span style="color:green">‚óè Agenda</span> |
  <span style="color:red">‚óè Segunda</span> |
  <span style="color:orange">‚óè Ter√ßa</span> |
  <span style="color:gold">‚óè Quarta</span> |
  <span style="color:purple">‚óè Quinta</span> |
  <span style="color:black">‚óè Sexta</span> |
  <span style="color:gray">‚óè S√°bado</span> |
  <span style="color:#f60">üî• Heatmap</span>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';
const map = L.map('map').setView([-15.7797, -47.9297], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const grupoMarcadores = L.layerGroup().addTo(map);
let heatLayer;
let dadosGlobal = [];

const filtros = {
  CDD: new Choices('#filtroCDD', { removeItemButton: true }),
  GN: new Choices('#filtroGN', { removeItemButton: true }),
  Inplant: new Choices('#filtroInplant', { removeItemButton: true }),
  Rede: new Choices('#filtroRede', { removeItemButton: true }),
  Dia: new Choices('#filtroDia', { removeItemButton: true })
};

const coresPorDia = {
  'Agenda': 'green', 'Segunda': 'red', 'Ter√ßa': 'orange',
  'Quarta': 'gold', 'Quinta': 'purple', 'Sexta': 'black', 'S√°bado': 'gray', 'Total': 'blue'
};

function preencherFiltros(dados, chave, controle) {
  const valores = [...new Set(dados.map(d => d[chave]).filter(Boolean))].sort();
  controle.clearChoices();
  controle.setChoices(valores.map(v => ({ value: v, label: v })), 'value', 'label', true);
}

function atualizarMapa(dados) {
  grupoMarcadores.clearLayers();
  const cdd = filtros.CDD.getValue(true);
  const gn = filtros.GN.getValue(true);
  const inplant = filtros.Inplant.getValue(true);
  const rede = filtros.Rede.getValue(true);
  const diasSelecionados = filtros.Dia.getValue(true);
  const pontosHeat = [];

  dados.forEach(d => {
    const lat = parseFloat(d['LAT']);
    const lon = parseFloat(d['LONG']);
    if (isNaN(lat) || isNaN(lon)) return;

    const cddValido = cdd.length === 0 || cdd.includes(d['CDD']);
    const gnValido = gn.length === 0 || gn.includes(d['GN']);
    const inplantValido = inplant.length === 0 || inplant.includes(d['Inplant']);
    const redeValido = rede.length === 0 || rede.includes(d['Rede']);
    let diaValido = false;
    let cor = 'blue';

    if (diasSelecionados.length === 0) {
      const dias = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
      for (let dia of dias) {
        if (d[dia]?.trim() === '1') {
          cor = coresPorDia[dia];
          diaValido = true;
          break;
        }
      }
    } else {
      for (let dia of diasSelecionados) {
        if (d[dia]?.trim() === '1') {
          cor = coresPorDia[dia];
          diaValido = true;
          break;
        }
      }
      if (!diaValido && diasSelecionados.includes('Agenda')) {
        const isAgenda = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'].every(dia => d[dia]?.trim() === '1');
        if (isAgenda) {
          diaValido = true;
          cor = coresPorDia['Agenda'];
        }
      }
    }

    if (cddValido && gnValido && inplantValido && redeValido && diaValido) {
      const marker = L.circleMarker([lat, lon], {
        radius: 6, color: cor, fillColor: cor, fillOpacity: 0.8, weight: 1
      }).bindPopup(`<b>${d['Nome']}</b><br>CDD: ${d['CDD']}<br>GN: ${d['GN']}<br>Inplant: ${d['Inplant']}<br>Rede: ${d['Rede']}`);
      grupoMarcadores.addLayer(marker);
      pontosHeat.push([lat, lon, 0.7]);
    }
  });

  if (heatLayer) map.removeLayer(heatLayer);
  if (document.body.classList.contains('heat-active')) {
    heatLayer = L.heatLayer(pontosHeat, { radius: 20 }).addTo(map);
  }
}

document.getElementById('heatToggle').addEventListener('click', () => {
  document.body.classList.toggle('heat-active');
  atualizarMapa(dadosGlobal);
});

Papa.parse(url, {
  download: true,
  header: true,
  complete: results => {
    const dados = results.data;
    dadosGlobal = dados;
    preencherFiltros(dados, 'CDD', filtros.CDD);
    preencherFiltros(dados, 'GN', filtros.GN);
    preencherFiltros(dados, 'Inplant', filtros.Inplant);
    preencherFiltros(dados, 'Rede', filtros.Rede);
    const diasSemana = ['Agenda','Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    filtros.Dia.clearChoices();
    filtros.Dia.setChoices(diasSemana.map(d => ({ value: d, label: d })), 'value', 'label', true);
    atualizarMapa(dados);
    Object.values(filtros).forEach(f => {
      f.passedElement.element.addEventListener('change', () => atualizarMapa(dados));
    });
  }
});
</script>
</body>
</html>
