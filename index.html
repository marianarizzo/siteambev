<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interativo com Filtros</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100%; }
        .filters {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filter-box {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="filters">
    <div class="filter-box">
        <label for="cddSelect">CDD:</label>
        <select id="cddSelect" multiple></select>
    </div>
    <div class="filter-box">
        <label for="camadaSelect">Tipo de Camada:</label>
        <select id="camadaSelect" multiple>
            <option value="Total">Total</option>
            <option value="Segunda">Segunda</option>
            <option value="Terça">Terça</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="Sábado">Sábado</option>
            <option value="Agendado">Agendado</option>
        </select>
    </div>
    <div class="filter-box">
        <label for="inplantSelect">Inplant:</label>
        <select id="inplantSelect" multiple></select>
    </div>
    <div class="filter-box">
        <label for="gnSelect">GN:</label>
        <select id="gnSelect" multiple></select>
    </div>
    <div class="filter-box">
        <label for="redeSelect">Rede:</label>
        <select id="redeSelect" multiple></select>
    </div>
</div>
<div id="map"></div>
<div class="legend" id="legend">
    <strong>Legenda:</strong><br>
    Total: Azul<br>
    Segunda: Vermelho<br>
    Terça: Laranja<br>
    Quarta: Verde<br>
    Quinta: Roxo<br>
    Sexta: Amarelo<br>
    Sábado: Rosa<br>
    Agendado: Preto
</div>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
<script>
    const map = L.map('map').setView([-15.77972, -47.92972], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let allMarkers = [];

    function updateMarkers(data) {
        allMarkers.forEach(m => map.removeLayer(m));
        allMarkers = [];

        const selectedCDDs = Array.from(document.getElementById('cddSelect').selectedOptions).map(opt => opt.value);
        const selectedCamadas = Array.from(document.getElementById('camadaSelect').selectedOptions).map(opt => opt.value);
        const selectedInplants = Array.from(document.getElementById('inplantSelect').selectedOptions).map(opt => opt.value);
        const selectedGNs = Array.from(document.getElementById('gnSelect').selectedOptions).map(opt => opt.value);
        const selectedRedes = Array.from(document.getElementById('redeSelect').selectedOptions).map(opt => opt.value);

        data.forEach(row => {
            if (
                (selectedCDDs.length === 0 || selectedCDDs.includes(row.CDD)) &&
                (selectedCamadas.length === 0 || selectedCamadas.includes(row.Dia)) &&
                (selectedInplants.length === 0 || selectedInplants.includes(row.Inplant)) &&
                (selectedGNs.length === 0 || selectedGNs.includes(row.GN)) &&
                (selectedRedes.length === 0 || selectedRedes.includes(row.Rede))
            ) {
                const colorMap = {
                    'Total': 'blue', 'Segunda': 'red', 'Terça': 'orange', 'Quarta': 'green',
                    'Quinta': 'purple', 'Sexta': 'yellow', 'Sábado': 'pink', 'Agendado': 'black'
                };
                const color = colorMap[row.Dia] || 'gray';
                const marker = L.circleMarker([parseFloat(row.Latitude), parseFloat(row.Longitude)], {
                    color: color,
                    radius: 6
                }).addTo(map).bindPopup(`<strong>${row.Loja}</strong><br>CDD: ${row.CDD}<br>Dia: ${row.Dia}`);
                allMarkers.push(marker);
            }
        });
    }

    Papa.parse('https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv', {
        download: true,
        header: true,
        complete: function(results) {
            const data = results.data.filter(row => row.Latitude && row.Longitude);
            const unique = (arr, col) => [...new Set(arr.map(r => r[col]).filter(Boolean))];
            
            unique(data, 'CDD').forEach(val => {
                let opt = document.createElement('option');
                opt.value = val; opt.text = val;
                document.getElementById('cddSelect').appendChild(opt);
            });
            unique(data, 'Inplant').forEach(val => {
                let opt = document.createElement('option');
                opt.value = val; opt.text = val;
                document.getElementById('inplantSelect').appendChild(opt);
            });
            unique(data, 'GN').forEach(val => {
                let opt = document.createElement('option');
                opt.value = val; opt.text = val;
                document.getElementById('gnSelect').appendChild(opt);
            });
            unique(data, 'Rede').forEach(val => {
                let opt = document.createElement('option');
                opt.value = val; opt.text = val;
                document.getElementById('redeSelect').appendChild(opt);
            });

            document.querySelectorAll('select').forEach(sel => sel.addEventListener('change', () => updateMarkers(data)));
            updateMarkers(data);
        }
    });
</script>
</body>
</html>