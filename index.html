<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Interativo Ambev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      z-index: 1000;
      background: transparent;
    }
    .control-panel select {
      padding: 5px;
      border-radius: 4px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 5px;
    }
    .legend span {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <select id="cddFilter" multiple></select>
    <select id="dayFilter" multiple>
      <option value="Segunda">Segunda</option>
      <option value="Terça">Terça</option>
      <option value="Quarta">Quarta</option>
      <option value="Quinta">Quinta</option>
      <option value="Sexta">Sexta</option>
      <option value="Sábado">Sábado</option>
      <option value="Agenda">Agenda</option>
    </select>
    <select id="inplantFilter" multiple></select>
    <select id="gnFilter" multiple></select>
  </div>

  <div class="legend">
    <strong>Legenda:</strong>
    <span style="color: red;">● Agenda</span>
    <span style="color: blue;">● Segunda</span>
    <span style="color: green;">● Terça</span>
    <span style="color: purple;">● Quarta</span>
    <span style="color: brown;">● Quinta</span>
    <span style="color: black;">● Sexta</span>
    <span style="color: orange;">● Sábado</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const map = L.map("map").setView([-10.5, -52], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const layerGroup = L.layerGroup().addTo(map);
    const colors = {
      "Agenda": "red",
      "Segunda": "blue",
      "Terça": "green",
      "Quarta": "purple",
      "Quinta": "brown",
      "Sexta": "black",
      "Sábado": "orange"
    };

    function loadData() {
      Papa.parse("https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20ASCD%20CO.csv", {
        download: true,
        header: true,
        complete: function (results) {
          const data = results.data;
          populateFilters(data);
          updateMap(data);
          document.querySelectorAll(".control-panel select").forEach(sel => {
            sel.addEventListener("change", () => updateMap(data));
          });
        },
      });
    }

    function populateFilters(data) {
      const cddSet = new Set();
      const inplantSet = new Set();
      const gnSet = new Set();
      data.forEach(row => {
        if (row.CDD) cddSet.add(row.CDD.trim());
        if (row.Inplant) inplantSet.add(row.Inplant.trim());
        if (row.GN) gnSet.add(row.GN.trim());
      });

      const cddFilter = document.getElementById("cddFilter");
      const inplantFilter = document.getElementById("inplantFilter");
      const gnFilter = document.getElementById("gnFilter");

      cddSet.forEach(val => cddFilter.add(new Option(val, val)));
      inplantSet.forEach(val => inplantFilter.add(new Option(val, val)));
      gnSet.forEach(val => gnFilter.add(new Option(val, val)));
    }

    function updateMap(data) {
      layerGroup.clearLayers();
      const selectedCDDs = getSelectedValues("cddFilter");
      const selectedDays = getSelectedValues("dayFilter");
      const selectedInplants = getSelectedValues("inplantFilter");
      const selectedGNs = getSelectedValues("gnFilter");

      data.forEach(row => {
        const lat = parseFloat(row.Lat);
        const lon = parseFloat(row.Lng);
        const dia = row["Dia de Rota"];
        const cdd = row["CDD"];
        const inplant = row["Inplant"];
        const gn = row["GN"];

        const diaValid = selectedDays.length === 0 || selectedDays.includes(dia);
        const cddValid = selectedCDDs.length === 0 || selectedCDDs.includes(cdd);
        const inplantValid = selectedInplants.length === 0 || selectedInplants.includes(inplant);
        const gnValid = selectedGNs.length === 0 || selectedGNs.includes(gn);

        if (lat && lon && diaValid && cddValid && inplantValid && gnValid) {
          const color = colors[dia] || "gray";
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            color: color,
            fillOpacity: 0.8,
          });
          marker.bindPopup(`<strong>Loja:</strong> ${row.Loja}<br><strong>CDD:</strong> ${cdd}<br><strong>Dia:</strong> ${dia}`);
          layerGroup.addLayer(marker);
        }
      });
    }

    function getSelectedValues(selectId) {
      const sel = document.getElementById(selectId);
      return Array.from(sel.selectedOptions).map(o => o.value);
    }

    loadData();
  </script>
</body>
</html>
