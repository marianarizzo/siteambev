<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo com Filtros Completos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; }
    .filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(255, 255, 255, 0.8);
      padding: 6px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.8);
      padding: 6px;
      border-radius: 6px;
      font-family: sans-serif;
    }
    select {
      padding: 3px;
    }
  </style>
</head>
<body>
<div class="filters">
  <label>Escolha o CDD:
    <select id="filtroCDD" multiple></select>
  </label>
  <label>Tipo de Camada:
    <select id="filtroDia" multiple></select>
  </label>
  <label>Filtrar por Inplant:
    <select id="filtroInplant" multiple></select>
  </label>
  <label>Filtrar por GN:
    <select id="filtroGN" multiple></select>
  </label>
  <label>Filtrar por Rede:
    <select id="filtroRede" multiple></select>
  </label>
</div>
<div id="map"></div>
<div class="legend">
  <strong>Legenda:</strong><br>
  <span style="color:red">●</span> Segunda<br>
  <span style="color:orange">●</span> Terça<br>
  <span style="color:green">●</span> Quarta<br>
  <span style="color:blue">●</span> Quinta<br>
  <span style="color:purple">●</span> Sexta<br>
  <span style="color:black">●</span> Sábado<br>
  <span style="color:gray">●</span> Agenda<br>
</div>

<script>
const map = L.map('map').setView([-15.78, -47.93], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

const cores = {
  "Segunda": "red",
  "Terça": "orange",
  "Quarta": "green",
  "Quinta": "blue",
  "Sexta": "purple",
  "Sábado": "black",
  "Agenda": "gray"
};

let markers = [];
const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';

function limparMarcadores() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function atualizarMapa(data) {
  limparMarcadores();
  const cdds = getValoresSelecionados('filtroCDD');
  const dias = getValoresSelecionados('filtroDia');
  const inplants = getValoresSelecionados('filtroInplant');
  const gns = getValoresSelecionados('filtroGN');
  const redes = getValoresSelecionados('filtroRede');

  data.forEach(row => {
    if (
      (cdds.length === 0 || cdds.includes(row.CDD)) &&
      (dias.length === 0 || dias.includes(row.Dia)) &&
      (inplants.length === 0 || inplants.includes(row.Inplant)) &&
      (gns.length === 0 || gns.includes(row.GN)) &&
      (redes.length === 0 || redes.includes(row.Rede))
    ) {
      const marker = L.circleMarker([parseFloat(row.Lat), parseFloat(row.Long)], {
        color: cores[row.Dia] || 'gray',
        radius: 8
      }).addTo(map).bindPopup(`<strong>${row.Loja}</strong><br>${row.Dia}`);
      markers.push(marker);
    }
  });
}

function getValoresSelecionados(id) {
  return Array.from(document.getElementById(id).selectedOptions).map(opt => opt.value);
}

function preencherSelect(id, valores) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  [...new Set(valores)].sort().forEach(v => {
    const option = document.createElement('option');
    option.value = option.textContent = v;
    select.appendChild(option);
  });
}

Papa.parse(url, {
  download: true,
  header: true,
  complete: results => {
    const data = results.data.filter(row => row.Lat && row.Long);
    atualizarMapa(data);

    preencherSelect('filtroCDD', data.map(r => r.CDD));
    preencherSelect('filtroDia', data.map(r => r.Dia));
    preencherSelect('filtroInplant', data.map(r => r.Inplant));
    preencherSelect('filtroGN', data.map(r => r.GN));
    preencherSelect('filtroRede', data.map(r => r.Rede));

    ['filtroCDD','filtroDia','filtroInplant','filtroGN','filtroRede'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => atualizarMapa(data));
    });
  }
});
</script>
</body>
</html>