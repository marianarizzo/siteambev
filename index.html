<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo com Filtros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }
    .filtro-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background-color: transparent;
    }
    select {
      padding: 4px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background-color: white;
      cursor: pointer;
    }
    .legenda {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 9999;
      background-color: white;
      padding: 5px;
      font-size: 12px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<div class="filtro-container">
  <select id="cdd-filter" multiple></select>
  <select id="gn-filter" multiple></select>
  <select id="inplant-filter" multiple></select>
  <select id="rede-filter" multiple></select>
</div>
<div id="map"></div>
<div class="legenda" id="legenda">
  <b>Legenda:</b><br>
  <span style="color: blue">●</span> Segunda<br>
  <span style="color: green">●</span> Terça<br>
  <span style="color: orange">●</span> Quarta<br>
  <span style="color: purple">●</span> Quinta<br>
  <span style="color: red">●</span> Sexta<br>
  <span style="color: gray">●</span> Agendado
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
<script>
  let map = L.map('map').setView([-15.77972, -47.92972], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let markersLayer = L.layerGroup().addTo(map);
  let originalData = [];

  function carregarCSV() {
    const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20ASCD%20CO.csv';
    Papa.parse(url, {
      download: true,
      header: true,
      complete: function(results) {
        originalData = results.data;
        popularFiltros(originalData);
        aplicarFiltros(originalData);
      }
    });
  }

  function popularFiltros(data) {
    const campos = ['CDD', 'GN', 'Inplant', 'Rede'];
    campos.forEach(campo => {
      let valoresUnicos = [...new Set(data.map(d => d[campo]).filter(Boolean))].sort();
      const select = document.getElementById(`${campo.toLowerCase()}-filter`);
      select.innerHTML = '';
      valoresUnicos.forEach(valor => {
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
      });
    });
  }

  function aplicarFiltros(data) {
    const selectedCDDs = Array.from(document.getElementById('cdd-filter').selectedOptions).map(o => o.value);
    const selectedGNs = Array.from(document.getElementById('gn-filter').selectedOptions).map(o => o.value);
    const selectedInplants = Array.from(document.getElementById('inplant-filter').selectedOptions).map(o => o.value);
    const selectedRedes = Array.from(document.getElementById('rede-filter').selectedOptions).map(o => o.value);

    const filtrados = data.filter(d =>
      (selectedCDDs.length === 0 || selectedCDDs.includes(d.CDD)) &&
      (selectedGNs.length === 0 || selectedGNs.includes(d.GN)) &&
      (selectedInplants.length === 0 || selectedInplants.includes(d.Inplant)) &&
      (selectedRedes.length === 0 || selectedRedes.includes(d.Rede))
    );
    atualizarMapa(filtrados);
  }

  function atualizarMapa(data) {
    markersLayer.clearLayers();
    data.forEach(d => {
      if (d.Latitude && d.Longitude) {
        let cor = 'blue';
        if (d.Dia === 'Terça') cor = 'green';
        else if (d.Dia === 'Quarta') cor = 'orange';
        else if (d.Dia === 'Quinta') cor = 'purple';
        else if (d.Dia === 'Sexta') cor = 'red';
        else if (d.Agenda === 'Sim') cor = 'gray';

        const marcador = L.circleMarker([parseFloat(d.Latitude), parseFloat(d.Longitude)], {
          radius: 6,
          color: cor,
          fillOpacity: 0.8
        }).bindPopup(`<b>${d.Loja}</b><br>${d.CDD} - ${d.Inplant}`);

        markersLayer.addLayer(marcador);
      }
    });
  }

  document.getElementById('cdd-filter').addEventListener('change', () => aplicarFiltros(originalData));
  document.getElementById('gn-filter').addEventListener('change', () => aplicarFiltros(originalData));
  document.getElementById('inplant-filter').addEventListener('change', () => aplicarFiltros(originalData));
  document.getElementById('rede-filter').addEventListener('change', () => aplicarFiltros(originalData));

  carregarCSV();
</script>
</body>
</html>
