<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo Ambev</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .filters {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
        }

        select {
            padding: 5px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="filters">
        <label for="cddFilter">Escolha o CDD:</label>
        <select id="cddFilter" multiple></select>

        <label for="camadaFilter">Tipo de Camada:</label>
        <select id="camadaFilter" multiple>
            <option value="Total">Total</option>
            <option value="Segunda">Segunda</option>
            <option value="Terça">Terça</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="Sábado">Sábado</option>
            <option value="Agenda">Agenda</option>
        </select>

        <label for="inplantFilter">Filtrar por Inplant:</label>
        <select id="inplantFilter" multiple></select>

        <label for="gnFilter">Filtrar por GN:</label>
        <select id="gnFilter" multiple></select>

        <label for="redeFilter">Filtrar por Rede:</label>
        <select id="redeFilter" multiple></select>
    </div>

    <div class="legend">
        <strong>Legenda:</strong><br>
        <span style="color:red;">●</span> Segunda<br>
        <span style="color:orange;">●</span> Terça<br>
        <span style="color:yellow;">●</span> Quarta<br>
        <span style="color:green;">●</span> Quinta<br>
        <span style="color:blue;">●</span> Sexta<br>
        <span style="color:purple;">●</span> Sábado<br>
        <span style="color:gray;">●</span> Agenda
    </div>

    <div id="map"></div>

    <script>
        const map = L.map('map').setView([-15.7797, -47.9297], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let allMarkers = [];

        fetch('https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv')
            .then(response => response.text())
            .then(data => {
                const rows = data.split('\n');
                const headers = rows[0].split(',');
                const content = rows.slice(1).map(r => r.split(','));

                const cddSet = new Set();
                const inplantSet = new Set();
                const gnSet = new Set();
                const redeSet = new Set();

                content.forEach(row => {
                    const lat = parseFloat(row[headers.indexOf('Latitude')]);
                    const lon = parseFloat(row[headers.indexOf('Longitude')]);
                    const dia = row[headers.indexOf('Dia Semana')];
                    const agenda = row[headers.indexOf('Agenda')];
                    const cdd = row[headers.indexOf('CDD')];
                    const inplant = row[headers.indexOf('Inplant')];
                    const gn = row[headers.indexOf('GN')];
                    const rede = row[headers.indexOf('Rede')];

                    cddSet.add(cdd);
                    inplantSet.add(inplant);
                    gnSet.add(gn);
                    redeSet.add(rede);

                    const colorMap = {
                        'Segunda': 'red', 'Terça': 'orange', 'Quarta': 'yellow', 'Quinta': 'green', 'Sexta': 'blue', 'Sábado': 'purple', 'Agenda': 'gray'
                    };
                    const color = agenda === 'Sim' ? 'gray' : colorMap[dia] || 'black';

                    const marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`<strong>CDD:</strong> ${cdd}<br><strong>Dia:</strong> ${dia}<br><strong>Inplant:</strong> ${inplant}<br><strong>GN:</strong> ${gn}<br><strong>Rede:</strong> ${rede}`);

                    marker.options.data = { dia, agenda, cdd, inplant, gn, rede };
                    allMarkers.push(marker);
                });

                function populateSelect(selectId, options) {
                    const select = document.getElementById(selectId);
                    [...options].sort().forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.text = value;
                        select.appendChild(option);
                    });
                }

                populateSelect('cddFilter', cddSet);
                populateSelect('inplantFilter', inplantSet);
                populateSelect('gnFilter', gnSet);
                populateSelect('redeFilter', redeSet);

                function filterMarkers() {
                    const selectedCDDs = Array.from(document.getElementById('cddFilter').selectedOptions).map(o => o.value);
                    const selectedCamadas = Array.from(document.getElementById('camadaFilter').selectedOptions).map(o => o.value);
                    const selectedInplants = Array.from(document.getElementById('inplantFilter').selectedOptions).map(o => o.value);
                    const selectedGNs = Array.from(document.getElementById('gnFilter').selectedOptions).map(o => o.value);
                    const selectedRedes = Array.from(document.getElementById('redeFilter').selectedOptions).map(o => o.value);

                    allMarkers.forEach(marker => {
                        const d = marker.options.data;
                        const visible =
                            (selectedCDDs.length === 0 || selectedCDDs.includes(d.cdd)) &&
                            (selectedCamadas.length === 0 ||
                                (selectedCamadas.includes('Agenda') && d.agenda === 'Sim') ||
                                (selectedCamadas.includes(d.dia) && d.agenda !== 'Sim')) &&
                            (selectedInplants.length === 0 || selectedInplants.includes(d.inplant)) &&
                            (selectedGNs.length === 0 || selectedGNs.includes(d.gn)) &&
                            (selectedRedes.length === 0 || selectedRedes.includes(d.rede));

                        if (visible) {
                            marker.addTo(map);
                        } else {
                            map.removeLayer(marker);
                        }
                    });
                }

                document.querySelectorAll('select').forEach(s => s.addEventListener('change', filterMarkers));

                allMarkers.forEach(marker => marker.addTo(map));
            });
    </script>
</body>

</html>