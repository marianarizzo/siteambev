<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo com Filtros</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .filtros {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        select {
            display: block;
            width: 200px;
            margin-bottom: 5px;
        }
        .legenda {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }
        .legenda span { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
    </style>
</head>
<body>
<div class="filtros">
    <label>Escolha o CDD: <select id="filtro-cdd" multiple></select></label>
    <label>Tipo de Camada: <select id="filtro-dia" multiple></select></label>
    <label>Filtrar por Inplant: <select id="filtro-inplant" multiple></select></label>
    <label>Filtrar por GN: <select id="filtro-gn" multiple></select></label>
    <label>Filtrar por Rede: <select id="filtro-rede" multiple></select></label>
</div>
<div id="map"></div>
<div class="legenda">
    <div><span style="background:red"></span> Agenda</div>
    <div><span style="background:blue"></span> Segunda</div>
    <div><span style="background:orange"></span> Terça</div>
    <div><span style="background:green"></span> Quarta</div>
    <div><span style="background:purple"></span> Quinta</div>
    <div><span style="background:black"></span> Sexta</div>
    <div><span style="background:gray"></span> Sábado</div>
</div>

<script>
const map = L.map('map').setView([-15.7797, -47.9297], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const marcadoresLayer = L.layerGroup().addTo(map);
let dadosFiltrados = [];

function normalize(str) {
    return str ? str.normalize("NFD").replace(/[̀-ͯ]/g, "") : "";
}

function gerarIcone(dia) {
    const cores = {
        "agenda": "red",
        "segunda": "blue",
        "terca": "orange",
        "quarta": "green",
        "quinta": "purple",
        "sexta": "black",
        "sabado": "gray"
    };
    return L.divIcon({ className: '', html: `<i style='background:${cores[dia] || "black"}; border-radius:50%; width:12px; height:12px; display:block;'></i>` });
}

function getSelecionados(id) {
    const select = document.getElementById(id);
    return Array.from(select.selectedOptions).map(opt => opt.value);
}

function atualizarFiltros(nomeCampo, idSelect) {
    const valores = [...new Set(dadosFiltrados.map(d => d[nomeCampo]).filter(Boolean))].sort();
    const select = document.getElementById(idSelect);
    select.innerHTML = valores.map(v => `<option value="${v}">${v}</option>`).join('');
}

function filtrarDados() {
    const cdds = getSelecionados('filtro-cdd');
    const dias = getSelecionados('filtro-dia').map(normalize);
    const inplants = getSelecionados('filtro-inplant');
    const gns = getSelecionados('filtro-gn');
    const redes = getSelecionados('filtro-rede');

    marcadoresLayer.clearLayers();

    dadosFiltrados.forEach(p => {
        const dia = normalize(p.Dia);
        if (
            (cdds.length === 0 || cdds.includes(p.CDD)) &&
            (dias.length === 0 || dias.includes(dia)) &&
            (inplants.length === 0 || inplants.includes(p.Inplant)) &&
            (gns.length === 0 || gns.includes(p.GN)) &&
            (redes.length === 0 || redes.includes(p.Rede))
        ) {
            const marker = L.marker([parseFloat(p.Latitude), parseFloat(p.Longitude)], {
                icon: gerarIcone(dia)
            }).bindPopup(`<strong>${p.Loja}</strong><br>Dia: ${p.Dia}<br>CDD: ${p.CDD}`);
            marcadoresLayer.addLayer(marker);
        }
    });
}

function carregarMapa() {
    const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';
    Papa.parse(url, {
        header: true,
        download: true,
        skipEmptyLines: true,
        complete: function(results) {
            dadosFiltrados = results.data;
            atualizarFiltros('CDD', 'filtro-cdd');
            atualizarFiltros('Dia', 'filtro-dia');
            atualizarFiltros('Inplant', 'filtro-inplant');
            atualizarFiltros('GN', 'filtro-gn');
            atualizarFiltros('Rede', 'filtro-rede');
            filtrarDados();
        }
    });
}

['filtro-cdd', 'filtro-dia', 'filtro-inplant', 'filtro-gn', 'filtro-rede'].forEach(id => {
    document.getElementById(id).addEventListener('change', filtrarDados);
});

carregarMapa();
</script>
</body>
</html>