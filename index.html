<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Interativo Ambev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    #map { height: 100vh; }
    .legend {
      position: fixed;
      bottom: 20px;
      left: 10px;
      background: white;
      padding: 6px;
      border-radius: 8px;
      font-size: 13px;
    }
    .legend i {
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
    .filter-box {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      z-index: 999;
    }
    .choices__inner { min-width: 200px; }
  </style>
</head>
<body>
  <div class="filter-box">
    <label>Escolha o CDD:</label>
    <select id="cddSelect" multiple></select>
    <label>Tipo de Camada:</label>
    <select id="diaSelect" multiple>
      <option>Segunda</option>
      <option>Terça</option>
      <option>Quarta</option>
      <option>Quinta</option>
      <option>Sexta</option>
      <option>Sábado</option>
      <option>Agenda</option>
    </select>
    <label>Filtrar por Inplant:</label>
    <select id="inplantSelect" multiple></select>
    <label>Filtrar por GN:</label>
    <select id="gnSelect" multiple></select>
    <label>Filtrar por Rede:</label>
    <select id="redeSelect" multiple></select>
  </div>

  <div id="map"></div>

  <div class="legend">
    <strong>Legenda:</strong><br />
    <i style="background: red"></i> Agenda<br />
    <i style="background: blue"></i> Segunda<br />
    <i style="background: orange"></i> Terça<br />
    <i style="background: yellow"></i> Quarta<br />
    <i style="background: green"></i> Quinta<br />
    <i style="background: black"></i> Sexta<br />
    <i style="background: gray"></i> Sábado<br />
  </div>

  <script>
    const map = L.map('map').setView([-10, -50], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const layers = {};
    const markerGroup = L.layerGroup().addTo(map);
    const colors = {
      'Agenda': 'red',
      'Segunda': 'blue',
      'Terça': 'orange',
      'Quarta': 'yellow',
      'Quinta': 'green',
      'Sexta': 'black',
      'Sábado': 'gray'
    };

    const csvUrl = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';

    function populateSelect(selectId, values) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';
      const sorted = [...new Set(values)].sort();
      sorted.forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.text = v;
        select.appendChild(option);
      });
      new Choices(select, { removeItemButton: true });
    }

    function applyFilters(data) {
      const selectedCDD = getSelectedValues('cddSelect');
      const selectedDias = getSelectedValues('diaSelect');
      const selectedInplants = getSelectedValues('inplantSelect');
      const selectedGN = getSelectedValues('gnSelect');
      const selectedRede = getSelectedValues('redeSelect');

      markerGroup.clearLayers();

      data.forEach(row => {
        const dia = row['Dia Semana'];
        const cdd = row['CDD'];
        const inplant = row['Inplant'];
        const gn = row['GN'];
        const rede = row['Rede'];
        const lat = parseFloat(row['Latitude']);
        const lon = parseFloat(row['Longitude']);

        if (
          (!selectedCDD.length || selectedCDD.includes(cdd)) &&
          (!selectedDias.length || selectedDias.includes(dia)) &&
          (!selectedInplants.length || selectedInplants.includes(inplant)) &&
          (!selectedGN.length || selectedGN.includes(gn)) &&
          (!selectedRede.length || selectedRede.includes(rede))
        ) {
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: colors[dia] || 'gray',
            fillOpacity: 0.8,
            color: '#000',
            weight: 1
          }).bindPopup(`<strong>Rede:</strong> ${rede}<br><strong>Dia:</strong> ${dia}<br><strong>Inplant:</strong> ${inplant}<br><strong>GN:</strong> ${gn}`);
          markerGroup.addLayer(marker);
        }
      });
    }

    function getSelectedValues(id) {
      const select = document.getElementById(id);
      return Array.from(select.selectedOptions).map(o => o.value);
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        const cdds = data.map(r => r['CDD']);
        const inplants = data.map(r => r['Inplant']);
        const gns = data.map(r => r['GN']);
        const redes = data.map(r => r['Rede']);

        populateSelect('cddSelect', cdds);
        populateSelect('inplantSelect', inplants);
        populateSelect('gnSelect', gns);
        populateSelect('redeSelect', redes);

        document.querySelectorAll('select').forEach(select => {
          select.addEventListener('change', () => applyFilters(data));
        });

        applyFilters(data);
      }
    });
  </script>
</body>
</html>