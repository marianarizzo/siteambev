<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
    }
    .filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 10px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background-color: white;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div class="filters">
  <label>CDD:</label>
  <select id="cddFilter" multiple></select><br>

  <label>GN:</label>
  <select id="gnFilter" multiple></select><br>

  <label>Inplant:</label>
  <select id="inplantFilter" multiple></select><br>

  <label>Rede:</label>
  <select id="redeFilter" multiple></select><br>

  <label>Camada:</label>
  <select id="camadaFilter">
    <option value="Total">Total</option>
    <option value="Agenda">Agenda</option>
    <option value="Segunda">Segunda</option>
    <option value="Terça">Terça</option>
    <option value="Quarta">Quarta</option>
    <option value="Quinta">Quinta</option>
    <option value="Sexta">Sexta</option>
    <option value="Sábado">Sábado</option>
  </select>
</div>

<div id="map"></div>
<div class="legend" id="legend">Legenda: Azul = Total | Verde = Agenda | Laranja = Dias da Semana</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script>
const map = L.map('map').setView([-15.77972, -47.92972], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let allData = [];

function loadData() {
  Papa.parse("https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv", {
    download: true,
    header: true,
    complete: function(results) {
      allData = results.data;
      populateFilters();
      updateMap();
    }
  });
}

function populateFilters() {
  const cddSet = new Set();
  const gnSet = new Set();
  const inplantSet = new Set();
  const redeSet = new Set();

  allData.forEach(row => {
    if (row.CDD) cddSet.add(row.CDD);
    if (row.GN) gnSet.add(row.GN);
    if (row.Inplant) inplantSet.add(row.Inplant);
    if (row.Rede) redeSet.add(row.Rede);
  });

  populateSelect("cddFilter", cddSet);
  populateSelect("gnFilter", gnSet);
  populateSelect("inplantFilter", inplantSet);
  populateSelect("redeFilter", redeSet);
}

function populateSelect(id, dataSet) {
  const select = document.getElementById(id);
  select.innerHTML = "";
  [...dataSet].sort().forEach(value => {
    const option = document.createElement("option");
    option.value = value;
    option.text = value;
    select.appendChild(option);
  });
}

let markers = [];

function updateMap() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const cddFilter = getSelectValues("cddFilter");
  const gnFilter = getSelectValues("gnFilter");
  const inplantFilter = getSelectValues("inplantFilter");
  const redeFilter = getSelectValues("redeFilter");
  const camada = document.getElementById("camadaFilter").value;

  allData.forEach(row => {
    if (
      (cddFilter.length === 0 || cddFilter.includes(row.CDD)) &&
      (gnFilter.length === 0 || gnFilter.includes(row.GN)) &&
      (inplantFilter.length === 0 || inplantFilter.includes(row.Inplant)) &&
      (redeFilter.length === 0 || redeFilter.includes(row.Rede))
    ) {
      if (row.Latitude && row.Longitude) {
        const showByCamada =
          camada === "Total" ||
          (camada === "Agenda" && row.Agenda === "Sim") ||
          camada === row.Dia;

        if (showByCamada) {
          const marker = L.circleMarker([parseFloat(row.Latitude), parseFloat(row.Longitude)], {
            radius: 6,
            color: camada === "Agenda" ? "green" :
                   camada === "Total" ? "blue" : "orange"
          }).addTo(map);
          marker.bindPopup(`
            <strong>${row.Loja}</strong><br>
            CDD: ${row.CDD}<br>
            Inplant: ${row.Inplant}<br>
            Dia: ${row.Dia}
          `);
          markers.push(marker);
        }
      }
    }
  });
}

function getSelectValues(id) {
  const select = document.getElementById(id);
  return [...select.selectedOptions].map(option => option.value);
}

["cddFilter", "gnFilter", "inplantFilter", "redeFilter", "camadaFilter"].forEach(id => {
  document.getElementById(id).addEventListener("change", updateMap);
});

loadData();
</script>

</body>
</html>
