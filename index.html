<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo - Ambev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 0;
    }

    .filtros {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: transparent;
      padding: 5px 5px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      font-family: sans-serif;
      max-width: calc(100vw - 40px);
    }

    .filtros label {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .filtros select {
      font-size: 12px;
      width: 220px;
      height: 20px;
      min-width: 220px;
      border-radius: 6px;
      padding: 6px 10px;
      box-sizing: border-box;
      border: 1px transparent;
      background-color: transparent;
    }

    .choices {
      width: 220px !important;
      min-width: 220px !important;
      max-width: 220px !important;
    }

    .choices__inner {
      min-height: 38px !important;
      height: auto !important;
      line-height: 36px !important;
      font-size: 14px;
      white-space: nowrap !important;
      text-overflow: ellipsis !important;
      overflow: hidden !important;
      padding: 6px 10px !important;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .choices__list--dropdown .choices__item {
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      max-width: 200px !important;
    }

    #botaoHeatmap {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1001;
      background-color: white;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-family: Arial, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    #legenda {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .filtros {
        flex-direction: column;
        align-items: flex-start;
        left: 10px;
        top: 10px;
        gap: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        max-width: 95vw;
      }

      .filtros .select-wrapper {
        width: 100%;
      }

      .choices,
      .choices__inner,
      .filtros select {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
      }

      .choices__inner {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: unset !important;
        min-height: 44px !important;
        line-height: 20px !important;
        word-break: normal !important;
        word-wrap: normal !important;
      }

      .choices__list--dropdown {
        max-height: 300px !important;
        overflow-y: auto !important;
        font-size: 16px !important;
      }

      .choices__list--dropdown .choices__item {
        white-space: normal !important;
        word-break: normal !important;
        word-wrap: normal !important;
        overflow: visible !important;
        max-width: 100% !important;
        padding: 10px !important;
      }

      .choices__item--selectable {
        display: flex !important;
        align-items: center;
        justify-content: flex-start;
      }

      #botaoHeatmap {
        font-size: 14px;
        padding: 8px 16px;
      }

      #legenda {
        font-size: 11px;
        padding: 5px;
        max-width: 95vw;
      }
    }
  </style>
</head>
<body>
  <div class="filtros">
    <div class="select-wrapper"><label>CDD</label><select id="filtroCDD" multiple></select></div>
    <div class="select-wrapper"><label>GN</label><select id="filtroGN" multiple></select></div>
    <div class="select-wrapper"><label>Inplant</label><select id="filtroInplant" multiple></select></div>
    <div class="select-wrapper"><label>Rede</label><select id="filtroRede" multiple></select></div>
    <div class="select-wrapper"><label>Dia</label><select id="filtroDia" multiple></select></div>
  </div>

  <button id="botaoHeatmap">Ativar Heatmap</button>
  <div id="map"></div>

  <div id="legenda">
    <b>Legenda:</b>
    <span style="color:red;">‚óè Agenda</span> |
    <span style="color:blue;">‚óè Segunda</span> |
    <span style="color:green;">‚óè Ter√ßa</span> |
    <span style="color:purple;">‚óè Quarta</span> |
    <span style="color:brown;">‚óè Quinta</span> |
    <span style="color:black;">‚óè Sexta</span> |
    <span style="color:orange;">‚óè S√°bado</span> |
    <span style="color:darkorange;">üî• Heatmap</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
    const url = 'https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20CSV.csv';
    const map = L.map('map').setView([-15.7797, -47.9297], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const grupoMarcadores = L.layerGroup().addTo(map);
    let heatLayer;

    const cddIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2776/2776067.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const cddLocations = [
      { name: 'GAM', lat: -16.001772915238647, lon: -48.05215353019492 },
      { name: 'CUI', lat: -15.56189216397978, lon: -56.12758838443211 },
      { name: 'GOI', lat: -16.609740763065844, lon: -49.292487087578984 },
      { name: 'MAN', lat: -3.021734706895321, lon: -60.02195693918584 }
    ];

    const filtros = {
      CDD: new Choices('#filtroCDD', { removeItemButton: true }),
      GN: new Choices('#filtroGN', { removeItemButton: true }),
      Inplant: new Choices('#filtroInplant', { removeItemButton: true }),
      Rede: new Choices('#filtroRede', { removeItemButton: true }),
      Dia: new Choices('#filtroDia', { removeItemButton: true })
    };

    const coresPorDia = {
      'Agenda': 'red',
      'Segunda': 'blue',
      'Ter√ßa': 'green',
      'Quarta': 'purple',
      'Quinta': 'brown',
      'Sexta': 'black',
      'S√°bado': 'orange'
    };

    function preencherFiltros(dados, chave, controle) {
      const valores = [...new Set(dados.map(d => d[chave]).filter(Boolean))].sort();
      controle.clearChoices();
      controle.setChoices(valores.map(v => ({ value: v, label: v })), 'value', 'label', true);
    }

    function atualizarMapa(dados) {
      grupoMarcadores.clearLayers();
      if (heatLayer) map.removeLayer(heatLayer);
      let heatData = [];

      cddLocations.forEach(loc => {
        L.marker([loc.lat, loc.lon], { icon: cddIcon }).bindPopup(
          `<b>${loc.name}</b><br>Latitude: ${loc.lat}<br>Longitude: ${loc.lon}`
        ).addTo(grupoMarcadores);
      });

      const cdd = filtros.CDD.getValue(true);
      const gn = filtros.GN.getValue(true);
      const inplant = filtros.Inplant.getValue(true);
      const rede = filtros.Rede.getValue(true);
      const diasSelecionados = filtros.Dia.getValue(true);

      dados.forEach(d => {
        const lat = parseFloat(d['LAT']);
        const lon = parseFloat(d['LONG']);
        if (isNaN(lat) || isNaN(lon)) return;

        const cddValido = cdd.length === 0 || cdd.includes(d['CDD']);
        const gnValido = gn.length === 0 || gn.includes(d['GN']);
        const inplantValido = inplant.length === 0 || inplant.includes(d['Inplant']);
        const redeValido = rede.length === 0 || rede.includes(d['Rede']);
        let diaValido = false;
        let cor = 'gray';

        const isAgenda = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'].every(dia => d[dia]?.trim() === '1');

        if (diasSelecionados.length === 0) {
          if (isAgenda) {
            diaValido = true;
            cor = coresPorDia['Agenda'];
          } else {
            for (let dia of ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado']) {
              if (d[dia]?.trim() === '1') {
                cor = coresPorDia[dia];
                diaValido = true;
                break;
              }
            }
          }
        } else {
          for (let dia of diasSelecionados) {
            if (dia === 'Agenda' && isAgenda) {
              diaValido = true;
              cor = coresPorDia['Agenda'];
            } else if (d[dia]?.trim() === '1') {
              diaValido = true;
              cor = coresPorDia[dia];
            }
          }
        }

        if (cddValido && gnValido && inplantValido && redeValido && diaValido) {
          heatData.push([lat, lon, 1]);
          const marker = L.circleMarker([lat, lon], {
            radius: 6,
            color: cor,
            fillColor: cor,
            fillOpacity: 0.8,
            weight: 1
          }).bindPopup(
            `<b>${d['Nome']}</b><br>CDD: ${d['CDD']}<br>GN: ${d['GN']}<br>Inplant: ${d['Inplant']}<br>Rede: ${d['Rede']}`
          );
          grupoMarcadores.addLayer(marker);
        }
      });

      heatLayer = L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 10 });
    }

    Papa.parse(url, {
      download: true,
      header: true,
      complete: results => {
        const dados = results.data;
        preencherFiltros(dados, 'CDD', filtros.CDD);
        preencherFiltros(dados, 'GN', filtros.GN);
        preencherFiltros(dados, 'Inplant', filtros.Inplant);
        preencherFiltros(dados, 'Rede', filtros.Rede);
        filtros.Dia.setChoices([
          { value: 'Agenda', label: 'Agenda' },
          { value: 'Segunda', label: 'Segunda' },
          { value: 'Ter√ßa', label: 'Ter√ßa' },
          { value: 'Quarta', label: 'Quarta' },
          { value: 'Quinta', label: 'Quinta' },
          { value: 'Sexta', label: 'Sexta' },
          { value: 'S√°bado', label: 'S√°bado' }
        ], 'value', 'label', true);
        atualizarMapa(dados);
        Object.values(filtros).forEach(f => {
          f.passedElement.element.addEventListener('change', () => atualizarMapa(dados));
        });
        document.getElementById('botaoHeatmap').addEventListener('click', () => {
          if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
          else heatLayer.addTo(map);
        });
      }
    });
  </script>
</body>
</html>
