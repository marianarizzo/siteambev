<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Interativo com Filtros</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .filter-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.85);
      padding: 10px;
      border-radius: 8px;
    }
    .filter-container select {
      width: 150px;
    }
    .legend {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div class="filter-container">
    <select id="cddSelect" multiple></select>
    <select id="diaSelect" multiple></select>
    <select id="inplantSelect" multiple></select>
    <select id="gnSelect" multiple></select>
  </div>
  <div id="map"></div>
  <div class="legend">
    <strong>Legenda:</strong>
    <div><span style="background:red;"></span>Agenda</div>
    <div><span style="background:blue;"></span>Segunda</div>
    <div><span style="background:green;"></span>Terça</div>
    <div><span style="background:purple;"></span>Quarta</div>
    <div><span style="background:brown;"></span>Quinta</div>
    <div><span style="background:black;"></span>Sexta</div>
    <div><span style="background:orange;"></span>Sábado</div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([-10.5, -53.2], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const cddSelect = $('#cddSelect').select2({ placeholder: "Escolha o CDD" });
    const diaSelect = $('#diaSelect').select2({ placeholder: "Dia da Semana" });
    const inplantSelect = $('#inplantSelect').select2({ placeholder: "Filtrar por Inplant" });
    const gnSelect = $('#gnSelect').select2({ placeholder: "Filtrar por GN" });

    let allMarkers = [];

    function clearMarkers() {
      allMarkers.forEach(marker => map.removeLayer(marker));
      allMarkers = [];
    }

    function renderMarkers(data) {
      clearMarkers();

      const selectedCDDs = cddSelect.val();
      const selectedDias = diaSelect.val();
      const selectedInplants = inplantSelect.val();
      const selectedGNs = gnSelect.val();

      data.forEach(row => {
        if (
          (!selectedCDDs.length || selectedCDDs.includes(row.CDD)) &&
          (!selectedDias.length || selectedDias.includes(row.Dia)) &&
          (!selectedInplants.length || selectedInplants.includes(row.Inplant)) &&
          (!selectedGNs.length || selectedGNs.includes(row.GN))
        ) {
          const colorMap = {
            'Agenda': 'red',
            'Segunda': 'blue',
            'Terça': 'green',
            'Quarta': 'purple',
            'Quinta': 'brown',
            'Sexta': 'black',
            'Sábado': 'orange'
          };
          const marker = L.circleMarker([+row.Latitude, +row.Longitude], {
            radius: 8,
            fillColor: colorMap[row.Dia],
            color: '#000',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map).bindPopup(<strong>${row.Loja}</strong><br>${row.Inplant});
          allMarkers.push(marker);
        }
      });
    }

    Papa.parse("https://raw.githubusercontent.com/marianarizzo/siteambev/main/Planner%20ASCD%20CO.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;

        const uniqueCDDs = [...new Set(data.map(row => row.CDD).filter(Boolean))];
        const uniqueDias = [...new Set(data.map(row => row.Dia).filter(Boolean))];
        const uniqueInplants = [...new Set(data.map(row => row.Inplant).filter(Boolean))];
        const uniqueGNs = [...new Set(data.map(row => row.GN).filter(Boolean))];

        uniqueCDDs.forEach(cdd => cddSelect.append(new Option(cdd, cdd)));
        uniqueDias.forEach(dia => diaSelect.append(new Option(dia, dia)));
        uniqueInplants.forEach(inplant => inplantSelect.append(new Option(inplant, inplant)));
        uniqueGNs.forEach(gn => gnSelect.append(new Option(gn, gn)));

        // Evento de filtragem
        cddSelect.on('change', () => renderMarkers(data));
        diaSelect.on('change', () => renderMarkers(data));
        inplantSelect.on('change', () => renderMarkers(data));
        gnSelect.on('change', () => renderMarkers(data));

        renderMarkers(data);
      }
    });
  </script>
</body>
</html>
